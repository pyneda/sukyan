<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }} - Sukyan Scanner Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
    <style>
        /* Custom scrollbar for better UX */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Transitions and animations */
        .fade-in {
            animation: fadeIn 0.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Make code blocks look better */
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            tab-size: 4;
            counter-reset: line;
        }
        
        /* Collapsible groups */
        .group-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .group-content.open {
            max-height: 9999px;
        }
        
        /* Highlighting for search results */
        .highlight {
            background-color: rgba(234, 179, 8, 0.3);
            padding: 1px 2px;
            border-radius: 2px;
        }
        
        /* Lazy-loaded content */
        .lazy-content {
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .lazy-content.loaded {
            opacity: 1;
        }
    </style>
</head>
<div id="loading-overlay" class="fixed inset-0 h-screen flex items-center justify-center bg-gray-900 bg-opacity-70 z-50 ">
  <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="text-white">Initializing report data...</p>
  </div>
</div>
<body class="bg-gray-900 text-gray-200 min-h-screen">
    <!-- Header Bar -->
    <div class="bg-gray-800 sticky top-0 z-10 shadow-lg border-b border-gray-700">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h1 class="text-xl md:text-2xl font-bold text-white">{{ .Title }}</h1>
            </div>
            <div class="mt-2 md:mt-0 flex space-x-3">
            <!-- Actions placeholder -->

            </div>
        </div>
    </div>
    
    <!-- Dashboard Summary -->
    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-gray-400 mb-2">Total Issues</h3>
                <div class="flex items-end">
                    <p class="text-4xl font-bold text-white">{{ .Summary.TotalIssues }}</p>
                    <p class="ml-2 text-gray-400">vulnerabilities</p>
                </div>
            </div>
            <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-gray-400 mb-2">Critical & High</h3>
                <div class="flex items-end">
                    <p class="text-4xl font-bold text-red-500">{{ add .Summary.CriticalCount .Summary.HighCount }}</p>
                    <p class="ml-2 text-gray-400">issues</p>
                </div>
            </div>
            <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-gray-400 mb-2">Issue Types</h3>
                <div class="flex items-end">
                    <p class="text-4xl font-bold text-yellow-400">{{ .Summary.UniqueIssueTypes }}</p>
                    <p class="ml-2 text-gray-400">categories</p>
                </div>
            </div>
            <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-gray-400 mb-2">Unique Affected Endpoints</h3>
                <div class="flex items-end">
                    <p class="text-4xl font-bold text-blue-400">{{ .Summary.UniqueAffectedEndpoints }}</p>
                    <p class="ml-2 text-gray-400">endpoints</p>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-gray-400 mb-3">Issues by Severity</h3>
                <div class="h-64">
                    <canvas id="severityChart"></canvas>
                </div>
            </div>
            <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-gray-400 mb-3">Top Issue Types</h3>
                <div class="h-64">
                    <canvas id="typesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="container mx-auto px-4 pb-16 flex flex-col lg:flex-row gap-6">
        <!-- Left sidebar with issue list -->
        <div class="lg:w-1/3">
            <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700 sticky top-24">
                <div class="mb-4">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Search issues..." 
                            class="w-full p-3 pl-10 border border-gray-700 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                        <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-3.5 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <p id="result-count" class="text-sm text-gray-400">{{ .Summary.TotalIssues }} issues</p>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-400">Filter:</label>
                            <select id="severity-filter" class="bg-gray-700 border border-gray-600 text-white rounded-md text-sm px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">All severities</option>
                                <option value="Critical">Critical</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                                <option value="Info">Info</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Container for issue list -->
                <div id="issues-container" class="space-y-3 max-h-[calc(100vh-280px)] overflow-y-auto pr-1"></div>
                

            </div>
        </div>
        
        <!-- Right panel with issue details -->
        <div id="details-container" class="lg:w-2/3">
            <div id="issue-details" class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <div class="flex items-center justify-center min-h-[200px]">
                    <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h2 class="mt-4 text-xl font-medium text-gray-400">Select a vulnerability to see details</h2>
                        <p class="mt-2 text-gray-500">Choose from the list on the left to view detailed information</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
        <!-- Toast notification for clipboard operations -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        Copied to clipboard
    </div>

    <script>
        
        // Load grouped issues
        const groupedIssues = {{ toJSON .GroupedIssues }};
        
        // Load summary data
        const summaryData = {{ toJSON .Summary }};

        // Setup application state
        let currentPage = 1;
        let itemsPerPage = 20;
        let currentFilteredIssues = groupedIssues || [];
        let currentSeverityFilter = 'all';
        let currentSelectedIssue = null;
        let searchTerm = '';
        
        // Initialize Fuse.js for search
        const fuseOptions = {
            keys: ['title', 'description', 'code', 'remediation'],
            threshold: 0.4,
            includeScore: true
        };
        const fuse = new Fuse(groupedIssues || [], fuseOptions);
        
        // Severity colors mapping
        const severityColors = {
            Critical: {
                bg: 'bg-red-800',
                text: 'text-red-800',
                border: 'border-red-800',
                light: 'bg-red-800 bg-opacity-20',
            },
            High: {
                bg: 'bg-orange-700',
                text: 'text-orange-700',
                border: 'border-orange-700',
                light: 'bg-orange-700 bg-opacity-20',
            },
            Medium: {
                bg: 'bg-yellow-500',
                text: 'text-yellow-500',
                border: 'border-yellow-500',
                light: 'bg-yellow-500 bg-opacity-20',
            },
            Low: {
                bg: 'bg-green-500',
                text: 'text-green-500',
                border: 'border-green-500',
                light: 'bg-green-500 bg-opacity-20',
            },
            Info: {
                bg: 'bg-blue-500',
                text: 'text-blue-500',
                border: 'border-blue-500',
                light: 'bg-blue-500 bg-opacity-20',
            },
            Unknown: {
                bg: 'bg-gray-600',
                text: 'text-gray-600',
                border: 'border-gray-600',
                light: 'bg-gray-600 bg-opacity-20',
            }
        };
        
        // Helper functions
        function decodeBase64(base64) {
            try {
                return atob(base64);
            } catch (e) {
                console.error('Error decoding Base64:', e);
                return 'Invalid Base64 data';
            }
        }
        
        function createElementWithClass(tag, className, content = null) {
            const element = document.createElement(tag);
            if (className) {
                element.className = className;
            }
            if (content !== null) {
                element.textContent = content;
            }
            return element;
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => showToast('Copied to clipboard'))
                .catch(err => showToast('Failed to copy: ' + err));
        }
        
        function toggleMessages(messagesId) {
            const messagesDiv = document.getElementById(messagesId);
            const toggleText = document.getElementById('toggle-text-' + messagesId.split('-')[1]);
            
            if (messagesDiv.classList.contains('hidden')) {
                messagesDiv.classList.remove('hidden');
                toggleText.textContent = 'Hide Messages';
            } else {
                messagesDiv.classList.add('hidden');
                toggleText.textContent = 'Show Messages';
            }
        }
        

        
        function highlightSearchTerm(text, term) {
            if (!term || typeof text !== 'string') return text;
            
            const regex = new RegExp('(' + term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }
        
        function createIssueCard(issue) {
            if (!issue) {
                console.warn('Attempted to create card for null/undefined issue');
                return createElementWithClass('div', 'bg-gray-700 rounded-md p-4 text-gray-400', 'Invalid issue data');
            }
            
            const card = createElementWithClass('div', 'bg-gray-700 rounded-md p-4 cursor-pointer hover:bg-gray-600 transition relative overflow-hidden');
            card.dataset.id = issue.id || '';
            
            // Add severity indicator stripe on the left
            const severityStripe = createElementWithClass('div', `absolute left-0 top-0 bottom-0 w-1 ${severityColors[issue.severity]?.bg || 'bg-gray-500'}`);
            card.appendChild(severityStripe);
            
            const cardContent = createElementWithClass('div', 'pl-2');
            
            // Title with issue code
            const titleContainer = createElementWithClass('div', 'flex justify-between items-start mb-1');
            
            let titleText = issue.title;
            if (searchTerm) {
                const titleEl = createElementWithClass('h3', 'font-bold text-white text-base');
                titleEl.innerHTML = highlightSearchTerm(titleText, searchTerm);
                titleContainer.appendChild(titleEl);
            } else {
                const titleEl = createElementWithClass('h3', 'font-bold text-white text-base', titleText);
                titleContainer.appendChild(titleEl);
            }
            
            // Metadata container (severity and confidence)
            const metaContainer = createElementWithClass('div', 'flex items-center space-x-2');
            
            // Severity badge
            const severityBadge = createElementWithClass(
                'span', 
                `text-xs font-medium px-2 py-1 rounded ${severityColors[issue.severity]?.light || 'bg-gray-600'}`,
                issue.severity
            );
            
            // Confidence indicator
            const confidenceColor = issue.confidence > 75 ? 'text-green-500' : 
                                  issue.confidence >= 50 ? 'text-yellow-500' : 'text-red-500';
            const confidenceBadge = createElementWithClass(
                'span',
                `text-xs font-medium ${confidenceColor} bg-gray-800 px-2 py-1 rounded`,
                `${issue.confidence}%`
            );
            
            metaContainer.appendChild(severityBadge);
            metaContainer.appendChild(confidenceBadge);
            
            titleContainer.appendChild(metaContainer);
            cardContent.appendChild(titleContainer);
            
            // URL (with possible highlighting)
            if (searchTerm && issue.url) {
                const urlEl = createElementWithClass('p', 'text-gray-400 text-sm truncate');
                urlEl.innerHTML = highlightSearchTerm(issue.url, searchTerm);
                cardContent.appendChild(urlEl);
            } else if (issue.url) {
                cardContent.appendChild(createElementWithClass('p', 'text-gray-400 text-sm truncate', issue.url));
            }
            
            // False positive indicator if applicable
            if (issue.false_positive) {
                const fpBadge = createElementWithClass(
                    'div',
                    'absolute top-2 right-2 text-xs bg-yellow-600 text-white px-2 py-1 rounded',
                    'False Positive'
                );
                card.appendChild(fpBadge);
            }
            
            card.appendChild(cardContent);
            
            // Event listener to show details when clicked
            card.addEventListener('click', () => {
                // Deselect current card if any
                const selectedCard = document.querySelector('.selected-card');
                if (selectedCard) {
                    selectedCard.classList.remove('selected-card', 'ring-2', 'ring-blue-500');
                }
                
                // Select this card
                card.classList.add('selected-card', 'ring-2', 'ring-blue-500');
                
                // Show details for this issue
                showIssueDetails(issue);
                currentSelectedIssue = issue;
            });
            
            return card;
        }
        
        function createGroupCard(group) {
            if (!group || !group.issues) {
                console.warn('Attempted to create group card for invalid group data');
                return createElementWithClass('div', 'bg-gray-700 rounded-md p-4 text-gray-400', 'Invalid group data');
            }
            
            const card = createElementWithClass('div', 'mb-4');
            
            // Create header
            const header = createElementWithClass('div', `flex items-center justify-between p-3 rounded-t-lg cursor-pointer ${severityColors[group.severity]?.light || 'bg-gray-700'}`);
            header.dataset.code = group.code;
            
            const titleWithCount = createElementWithClass('h3', 'font-semibold flex items-center', `${group.title} (${group.count})`);
            
            const collapseIcon = createElementWithClass('span', 'transform transition-transform');
            collapseIcon.style.transform = 'rotate(-90deg)';
            collapseIcon.innerHTML = '&#9660;'; // Down arrow icon

            header.appendChild(titleWithCount);
            header.appendChild(collapseIcon);
            
            // Create content area for issues in this group
            const content = createElementWithClass('div', 'border-l border-r border-b border-gray-600 rounded-b-lg overflow-hidden group-content');
            content.dataset.code = group.code;
            
            // Add the issues to this group
            group.issues.forEach(issue => {
                // Apply current filters
                if (currentSeverityFilter !== 'all' && issue.severity !== currentSeverityFilter) {
                    return;
                }
                
                content.appendChild(createIssueCard(issue));
            });
            
            // Toggle expansion when header is clicked
            header.addEventListener('click', () => {
                content.classList.toggle('open');
                collapseIcon.style.transform = content.classList.contains('open') ? 'rotate(0)' : 'rotate(-90deg)';
            });
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }
        
        function renderIssuesList() {
            const container = document.getElementById('issues-container');
            container.innerHTML = '';

            const filteredGroups = (currentFilteredIssues || []).filter(group => {
                return group.issues && group.issues.some(issue => {
                    return currentSeverityFilter === 'all' || issue.severity === currentSeverityFilter;
                });
            });
            
            // Render grouped issues
            filteredGroups.forEach(group => {
                container.appendChild(createGroupCard(group));
            });
            
            if (filteredGroups.length === 0) {
                container.appendChild(createElementWithClass('div', 'text-center text-gray-500 py-6', 'No issues match your filters'));
            }

            

        }
        
        
        function showIssueDetails(issue) {
            if (!issue) {
                console.warn('Attempted to show details for null/undefined issue');
                const container = document.getElementById('issue-details');
                container.innerHTML = '<div class="text-center text-gray-500 py-6">No issue selected</div>';
                return;
            }
            
            const container = document.getElementById('issue-details');
            container.innerHTML = '';
            container.classList.add('fade-in');
            
            const headerSection = createElementWithClass('div', 'mb-6');
            
            const titleRow = createElementWithClass('div', 'flex justify-between items-start');
            
            const title = createElementWithClass('h2', 'text-2xl font-bold text-white', issue.title);
            
            const metaContainer = createElementWithClass('div', 'flex items-center space-x-3');
            
            const severityBadge = createElementWithClass(
                'span', 
                `text-sm font-medium px-3 py-1 rounded ${severityColors[issue.severity]?.light || 'bg-gray-600'}`,
                issue.severity
            );
            
            const confidenceColor = issue.confidence > 75 ? 'text-green-500' : 
                                  issue.confidence >= 50 ? 'text-yellow-500' : 'text-red-500';
            const confidenceBadge = createElementWithClass(
                'span',
                `text-sm font-medium ${confidenceColor} bg-gray-700 px-3 py-1 rounded`,
                `${issue.confidence}% Confidence`
            );
            
            metaContainer.appendChild(severityBadge);
            metaContainer.appendChild(confidenceBadge);
            
            titleRow.appendChild(title);
            titleRow.appendChild(metaContainer);
            
            headerSection.appendChild(titleRow);
            
            if (issue.created_at) {
                headerSection.appendChild(createElementWithClass('p', 'text-sm text-gray-400 mt-2', `Detected: ${issue.created_at}`));
            }
            
            const urlContainer = createElementWithClass('div', 'flex items-center mt-4 bg-gray-700 p-2 rounded');
            const urlText = createElementWithClass('span', 'text-gray-300 flex-grow break-all', issue.url);
            
            const copyButton = createElementWithClass('button', 'ml-2 text-gray-400 hover:text-white p-1 transition');
            copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
            </svg>`;
            copyButton.addEventListener('click', (e) => {
                e.stopPropagation();
                copyToClipboard(issue.url);
            });
            
            urlContainer.appendChild(urlText);
            urlContainer.appendChild(copyButton);
            
            headerSection.appendChild(urlContainer);
            
            // HTTP details
            const httpDetails = createElementWithClass('div', 'flex flex-wrap mt-2 gap-2');
            httpDetails.appendChild(createElementWithClass('span', 'bg-gray-700 px-2 py-1 rounded text-sm', `Method: ${issue.http_method}`));
            httpDetails.appendChild(createElementWithClass('span', 'bg-gray-700 px-2 py-1 rounded text-sm', `Status: ${issue.status_code}`));
            if (issue.cwe) {
                httpDetails.appendChild(createElementWithClass('span', 'bg-gray-700 px-2 py-1 rounded text-sm', `CWE: ${issue.cwe}`));
            }
            
            headerSection.appendChild(httpDetails);
            
            // False positive warning if needed
            if (issue.false_positive) {
                const fpWarning = createElementWithClass('div', 'bg-yellow-800 bg-opacity-30 border border-yellow-700 text-yellow-200 p-3 rounded-md mt-4 flex items-center');
                fpWarning.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    This issue has been marked as a false positive
                `;
                headerSection.appendChild(fpWarning);
            }
            
            container.appendChild(headerSection);
            
            if (issue.description) {
                const descriptionSection = createElementWithClass('div', 'mb-6');
                descriptionSection.appendChild(createElementWithClass('h3', 'text-xl font-semibold text-white mb-2', 'Description'));
                descriptionSection.appendChild(createElementWithClass('div', 'text-gray-300 whitespace-pre-line', issue.description));
                container.appendChild(descriptionSection);
            }
            
            if (issue.details) {
                const detailsSection = createElementWithClass('div', 'mb-6');
                detailsSection.appendChild(createElementWithClass('h3', 'text-xl font-semibold text-white mb-2', 'Details'));
                detailsSection.appendChild(createElementWithClass('div', 'text-gray-300 whitespace-pre-line', issue.details));
                container.appendChild(detailsSection);
            }
            
            if (issue.note) {
                const noteSection = createElementWithClass('div', 'mb-6');
                noteSection.appendChild(createElementWithClass('h3', 'text-xl font-semibold text-white mb-2', 'Note'));
                noteSection.appendChild(createElementWithClass('div', 'text-gray-300 whitespace-pre-line', issue.note));
                container.appendChild(noteSection);
            }
            
            if (issue.remediation) {
                const remediationSection = createElementWithClass('div', 'mb-6 bg-green-900 bg-opacity-20 p-4 rounded-md border border-green-800');
                remediationSection.appendChild(createElementWithClass('h3', 'text-xl font-semibold text-white mb-2', 'Remediation'));
                remediationSection.appendChild(createElementWithClass('div', 'text-gray-300 whitespace-pre-line', issue.remediation));
                container.appendChild(remediationSection);
            }
            
            // References section
            if (issue.references && issue.references.length > 0) {
                const referencesSection = createElementWithClass('div', 'mb-6');
                referencesSection.appendChild(createElementWithClass('h3', 'text-xl font-semibold text-white mb-2', 'References'));
                
                const refList = createElementWithClass('ul', 'list-disc pl-5 space-y-1');
                issue.references.forEach(ref => {
                    const li = createElementWithClass('li', '');
                    const a = createElementWithClass('a', 'text-blue-400 hover:underline', ref);
                    a.href = ref;
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                    li.appendChild(a);
                    refList.appendChild(li);
                });
                
                referencesSection.appendChild(refList);
                container.appendChild(referencesSection);
            }
            container.appendChild(createElementWithClass('h3', 'text-xl font-semibold text-white mb-2', 'Technical Details'));
            if (issue.payload) {
                const payloadSection = createTechnicalSection('Payload', issue.payload, false);
                container.appendChild(payloadSection);
            }
            
            if (issue.curl_command) {
                const curlSection = createTechnicalSection('cURL Command', issue.curl_command, false);
                container.appendChild(curlSection);
            }
            
            if (issue.request) {
                const requestData = decodeBase64(issue.request);
                const requestSection = createTechnicalSection('HTTP Request', requestData, issue.request_truncated);
                container.appendChild(requestSection);
            }
            
            if (issue.response) {
                const responseData = decodeBase64(issue.response);
                const responseSection = createTechnicalSection('HTTP Response', responseData, issue.response_truncated);
                container.appendChild(responseSection);
            }
            
            // WebSocket Connection section
            if (issue.websocket_connection) {
                const wsSection = createWebSocketSection(issue.websocket_connection);
                container.appendChild(wsSection);
            }
        }
        
        function createTechnicalSection(title, content, isTruncated = false) {
            const section = createElementWithClass('div', 'mb-4 border border-gray-700 rounded-lg overflow-hidden');
            
            // Use consistent subtle styling for all sections
            let headerClass = 'bg-gray-700';
            let iconColor = 'text-gray-300';
            let icon = '';
            
            if (title.includes('Payload')) {
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>`;
            } else if (title.includes('HTTP Request')) {
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>`;
            } else if (title.includes('HTTP Response')) {
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" />
                </svg>`;
            } else if (title.includes('cURL')) {
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>`;
            }
            
            // Create collapsible header
            const header = createElementWithClass('div', `${headerClass} p-3 flex justify-between items-center cursor-pointer`);
            
            // Create title container with icon and truncation indicator if needed
            const titleContainer = createElementWithClass('div', 'flex items-center');
            
            const titleWithIcon = createElementWithClass('div', 'flex items-center text-white');
            titleWithIcon.innerHTML = `${icon}<h3 class="text-lg font-medium">${title}</h3>`;
            titleContainer.appendChild(titleWithIcon);
            
            if (isTruncated) {
                const truncationIndicator = createElementWithClass('span', 'ml-3 px-2 py-1 text-xs bg-yellow-600 text-yellow-100 rounded-full shadow-md');
                truncationIndicator.textContent = 'TRUNCATED';
                truncationIndicator.title = 'Content has been truncated due to size limits';
                titleContainer.appendChild(truncationIndicator);
            }
            
            header.appendChild(titleContainer);
            
            const toggleIcon = createElementWithClass('span', 'text-white opacity-75 hover:opacity-100 transition-opacity');
            toggleIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>';
            header.appendChild(toggleIcon);
            
            // Create content area (collapsed by default)
            const contentArea = createElementWithClass('div', 'hidden');
            
            const pre = createElementWithClass('pre', 'p-4 text-sm text-gray-300 bg-gray-800 overflow-x-auto border-t border-gray-600', content);
            
            // Add copy button with better styling
            const copyButtonContainer = createElementWithClass('div', 'flex justify-end p-3 bg-gray-750 border-t border-gray-600');
            const copyButton = createElementWithClass('button', 'text-sm bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md flex items-center transition-all shadow-md hover:shadow-lg');
            copyButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                </svg>
                Copy to Clipboard
            `;
            copyButton.addEventListener('click', () => copyToClipboard(content));
            copyButtonContainer.appendChild(copyButton);
            
            contentArea.appendChild(pre);
            contentArea.appendChild(copyButtonContainer);
            
            // Toggle content visibility when header is clicked
            header.addEventListener('click', () => {
                contentArea.classList.toggle('hidden');
                toggleIcon.innerHTML = contentArea.classList.contains('hidden') 
                    ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>';
            });
            
            section.appendChild(header);
            section.appendChild(contentArea);
            
            return section;
        }
        
        function createWebSocketSection(wsConnection) {
            const wsSection = createElementWithClass('div', 'mb-6');
            
            // WebSocket header
            const header = createElementWithClass('h3', 'text-xl font-semibold text-white mb-4 flex items-center');
            header.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.22c5.464-5.464 14.959-5.464 20.423 0" />
                </svg>
                WebSocket Connection
            `;
            wsSection.appendChild(header);
            
            // Connection info panel
            const infoPanel = createElementWithClass('div', 'bg-gradient-to-r from-blue-900/30 to-purple-900/30 border border-blue-600/30 rounded-lg p-4 mb-4');
            
            // Connection details
            const connectionDetails = createElementWithClass('div', 'grid grid-cols-1 md:grid-cols-2 gap-4');
            
            // URL
            const urlDiv = createElementWithClass('div', '');
            urlDiv.innerHTML = `
                <div class="text-sm text-gray-400 mb-1">WebSocket URL</div>
                <div class="text-blue-300 font-mono text-sm break-all">${wsConnection.url}</div>
            `;
            connectionDetails.appendChild(urlDiv);
            
            // Status
            const statusDiv = createElementWithClass('div', '');
            const statusColor = wsConnection.status === 'connected' ? 'text-green-400' : 
                               wsConnection.status === 'closed' ? 'text-red-400' : 'text-yellow-400';
            statusDiv.innerHTML = `
                <div class="text-sm text-gray-400 mb-1">Status</div>
                <div class="flex items-center">
                    <div class="w-2 h-2 rounded-full mr-2 ${wsConnection.status === 'connected' ? 'bg-green-400' : 
                                                           wsConnection.status === 'closed' ? 'bg-red-400' : 'bg-yellow-400'}"></div>
                    <span class="${statusColor} capitalize">${wsConnection.status}</span>
                </div>
            `;
            connectionDetails.appendChild(statusDiv);
            
            // Timestamps
            if (wsConnection.created_at) {
                const connectedDiv = createElementWithClass('div', '');
                connectedDiv.innerHTML = `
                    <div class="text-sm text-gray-400 mb-1">Connected At</div>
                    <div class="text-gray-300 text-sm">${wsConnection.created_at}</div>
                `;
                connectionDetails.appendChild(connectedDiv);
            }
            
            if (wsConnection.closed_at) {
                const closedDiv = createElementWithClass('div', '');
                closedDiv.innerHTML = `
                    <div class="text-sm text-gray-400 mb-1">Closed At</div>
                    <div class="text-gray-300 text-sm">${wsConnection.closed_at}</div>
                `;
                connectionDetails.appendChild(closedDiv);
            }
            
            infoPanel.appendChild(connectionDetails);
            wsSection.appendChild(infoPanel);
            
            // Messages timeline
            if (wsConnection.messages && wsConnection.messages.length > 0) {
                const messagesHeader = createElementWithClass('h4', 'text-lg font-medium text-white mb-3 flex items-center');
                messagesHeader.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    Message Flow (${wsConnection.messages.length} messages)
                `;
                wsSection.appendChild(messagesHeader);
                
                const timeline = createElementWithClass('div', 'space-y-3');
                
                // Sort messages by timestamp to ensure proper chronological order
                const sortedMessages = [...wsConnection.messages].sort((a, b) => {
                    if (!a.timestamp || !b.timestamp) return 0;
                    return new Date(a.timestamp) - new Date(b.timestamp);
                });
                
                sortedMessages.forEach((message, index) => {
                    const messageDiv = createElementWithClass('div', 'relative');
                    
                    // Timeline connector (except for last message)
                    if (index < sortedMessages.length - 1) {
                        const connector = createElementWithClass('div', 'absolute left-6 top-12 w-0.5 h-8 bg-gray-600');
                        messageDiv.appendChild(connector);
                    }
                    
                    const messageContent = createElementWithClass('div', 
                        `flex items-start space-x-3 ${message.direction === 'sent' ? 'flex-row' : 'flex-row'}`
                    );
                    
                    // Direction icon with message index
                    const iconDiv = createElementWithClass('div', 
                        `flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center relative ${
                            message.direction === 'sent' 
                                ? 'bg-blue-600 text-blue-200' 
                                : 'bg-green-600 text-green-200'
                        }`
                    );
                    
                    // Message index badge
                    const indexBadge = createElementWithClass('div', 
                        'absolute -top-1 -right-1 w-5 h-5 bg-gray-800 text-white text-xs rounded-full flex items-center justify-center border border-gray-600'
                    );
                    indexBadge.textContent = index + 1;
                    iconDiv.appendChild(indexBadge);
                    
                    iconDiv.innerHTML += message.direction === 'sent' 
                        ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                           </svg>`
                        : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" />
                           </svg>`;
                    
                    messageContent.appendChild(iconDiv);
                    
                    // Message bubble
                    const messageBubble = createElementWithClass('div', 
                        `flex-1 ${message.direction === 'sent' 
                            ? 'bg-blue-900/40 border-blue-600/30' 
                            : 'bg-green-900/40 border-green-600/30'
                        } border rounded-lg p-4`
                    );
                    
                    // Message header
                    const messageHeader = createElementWithClass('div', 'flex justify-between items-center mb-2');
                    const directionLabel = createElementWithClass('span', 
                        `text-sm font-medium ${message.direction === 'sent' ? 'text-blue-300' : 'text-green-300'}`
                    );
                    directionLabel.textContent = `Message ${index + 1} (${message.direction === 'sent' ? 'Sent' : 'Received'})`;
                    messageHeader.appendChild(directionLabel);
                    
                    if (message.timestamp) {
                        const timestamp = createElementWithClass('span', 'text-xs text-gray-400');
                        timestamp.textContent = message.timestamp;
                        messageHeader.appendChild(timestamp);
                    }
                    
                    messageBubble.appendChild(messageHeader);
                    
                    // Message content
                    const messageText = createElementWithClass('div', 'text-gray-200 text-sm');
                    const content = message.payload_data || '(No message content)';
                    
                    // Try to format JSON if it looks like JSON
                    let formattedContent = content;
                    try {
                        if (content.trim().startsWith('{') || content.trim().startsWith('[')) {
                            formattedContent = JSON.stringify(JSON.parse(content), null, 2);
                        }
                    } catch (e) {
                        // Not JSON, use as-is
                    }
                    
                    const preElement = createElementWithClass('pre', 'whitespace-pre-wrap font-mono text-xs bg-black/20 p-2 rounded mt-2 overflow-x-auto');
                    preElement.textContent = formattedContent;
                    messageText.appendChild(preElement);
                    
                    // Copy button for message content
                    const copyBtn = createElementWithClass('button', 
                        'mt-2 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded flex items-center transition'
                    );
                    copyBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                        </svg>
                        Copy
                    `;
                    copyBtn.addEventListener('click', () => copyToClipboard(formattedContent));
                    messageText.appendChild(copyBtn);
                    
                    messageBubble.appendChild(messageText);
                    messageContent.appendChild(messageBubble);
                    messageDiv.appendChild(messageContent);
                    timeline.appendChild(messageDiv);
                });
                
                wsSection.appendChild(timeline);
            } else {
                // No messages
                const noMessages = createElementWithClass('div', 'text-center py-8 text-gray-400');
                noMessages.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                    <p>No WebSocket messages recorded</p>
                `;
                wsSection.appendChild(noMessages);
            }
            
            return wsSection;
        }
        
        function filterIssues() {
            let filtered = (groupedIssues || []).filter(issue => {
                if (currentSeverityFilter !== 'all' && issue.severity !== currentSeverityFilter) {
                    return false;
                }
                return true;
            });
            
            if (searchTerm) {
                const searchResults = fuse.search(searchTerm);
                const matchedIds = new Set(searchResults.map(result => result.item.code));
                filtered = filtered.filter(issue => matchedIds.has(issue.code));
            }
            
            currentFilteredIssues = filtered;
            currentPage = 1; 
            
            renderIssuesList();
        }
        

        
        function initializeCharts() {
            // Severity chart (pie chart)
            const severityChartElement = document.getElementById('severityChart');
            if (!severityChartElement) {
                console.warn('Severity chart element not found');
                return;
            }
            
            const severityCtx = severityChartElement.getContext('2d');
            const severityLabels = ['Critical', 'High', 'Medium', 'Low', 'Info'];
            const severityData = [
                summaryData.critical_count || 0,
                summaryData.high_count || 0,
                summaryData.medium_count || 0,
                summaryData.low_count || 0,
                summaryData.info_count || 0
            ];

            const severityColors = [
                '#dc2626', // Critical - red
                '#c2410c', // High - orange 
                '#d2a937', // Medium - yellow
                '#2a8351', // Low - green
                '#2564a7'  // Info - blue
            ];
            
            new Chart(severityCtx, {
                type: 'doughnut',
                data: {
                    labels: severityLabels,
                    datasets: [{
                        data: severityData,
                        backgroundColor: severityColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e5e7eb' // Light gray text
                            }
                        }
                    }
                }
            });
            
            // Top issue types (bar chart)
            const typesChartElement = document.getElementById('typesChart');
            if (!typesChartElement) {
                console.warn('Types chart element not found');
                return;
            }
            
            const typesCtx = typesChartElement.getContext('2d');
            
            const typeLabels = summaryData.top_vuln_types ? summaryData.top_vuln_types.map(t => t.title) : [];
            const typeData = summaryData.top_vuln_types ? summaryData.top_vuln_types.map(t => t.count) : [];
            
            new Chart(typesCtx, {
                type: 'bar',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        label: 'Issues',
                        data: typeData,
                        backgroundColor: '#3b82f6', // Blue
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)' // Subtle grid lines
                            },
                            ticks: {
                                color: '#e5e7eb' // Light gray text
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#e5e7eb' // Light gray text
                            }
                        }
                    }
                }
            });
        }
        
        function initApp() {
            // Search functionality
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', e => {
                    searchTerm = e.target.value.trim();
                    filterIssues();
                });
            }
            
            // Severity filter
            const severityFilter = document.getElementById('severity-filter');
            if (severityFilter) {
                severityFilter.addEventListener('change', e => {
                    currentSeverityFilter = e.target.value;
                    filterIssues();
                });
            }
            

            

            
            
            initializeCharts();
            
            renderIssuesList();

            hideLoading();
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        showLoading();
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>

</html>